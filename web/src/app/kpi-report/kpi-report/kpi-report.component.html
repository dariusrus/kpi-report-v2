<ng-container *ngIf="!isLoading; else loadingOrError">
  <ng-container *ngIf="reportData; else noDataTemplate">
  <p-scrollTop icon="pi pi-angle-up"/>
  <div class="feedback-button">
    <a href="https://builderleadconverter.atlassian.net/servicedesk/customer/portal/5/group/6/create/34" target="_blank" rel="noopener noreferrer">
      <button>Give Us Feedback!
        <i class="ms-2 pi pi-external-link"></i>
      </button>
    </a>
  </div>
  <div class="header-container sticky">
    <div class="container header-sub-container">
      <div class="header-labels d-flex align-items-center">
        <img src="https://www.builderleadconverter.com/wp-content/uploads/2021/02/favicon.png" alt="Logo" class="header-logo me-2"/>
        <div class="title">KPI Report V2 <span class="release-version">beta 1.0</span></div>
      </div>

      <div class="dropdown-container">
        <p-toggleButton
          [(ngModel)]="displayComparisons"
          onLabel="{{ averageLabel }}"
          offLabel="{{ averageLabel }}"/>
        <p-dropdown
          [options]="months"
          [(ngModel)]="selectedMonth"
          (onChange)="onMonthChange()"
        />
        <p-dropdown
          [options]="years"
          [(ngModel)]="selectedYear"
          (onChange)="onYearChange()"
        />
      </div>
    </div>
  </div>
  <div class="container">
    <div class="dashboard-text">KPI Dashboard</div>
    <div class="sub-agency-name">{{ reportData.subAgency }}</div>
    <div class="row" style="min-height: 200px"
         snInViewport
         (inViewportChange)="handleViewportChange($event, 'summary')"
         [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}">
      <div class="col-12" *ngIf="isVisible['summary']">
        <ngx-charts-number-card
          [scheme]="'vivid'"
          [results]="numberCards"
          [valueFormatting]="valueFormatting"
          [cardColor]="'#ffffff'">
        </ngx-charts-number-card>
      </div>
    </div>

    <div>
      <div class="row report-row" [class.legend]="displayComparisons" style="min-height: 500px"
           snInViewport
           (inViewportChange)="handleViewportChange($event, 'analytics')"
           [inViewportOptions]="{rootMargin: '0px', threshold: 0.3}"
      >
        <div class="col-6">
          <div class="report-container">
            <div class="report-title">
              Google Analytics
            </div>
            <div class="report-subtitle">
              (Last {{ monthCount }} months)
            </div>
            <div class="report-data" *ngIf="isVisible['analytics']">
              <ngx-charts-bar-vertical *ngIf="!displayComparisons"
                                       [scheme]="'forest'"
                                       [results]="gaBarChart"
                                       [gradient]="true"
                                       [roundEdges]="false"
                                       [xAxis]="showXAxis"
                                       [yAxis]="showYAxis"
                                       [showDataLabel]="true"
                                       [showXAxisLabel]="showXAxisLabel"
                                       [showYAxisLabel]="showYAxisLabel"
                                       [xAxisLabel]="xAxisLabel"
                                       [yAxisLabel]="'Unique Site Visitors'"
              >
              </ngx-charts-bar-vertical>
              <ngx-charts-bar-vertical-2d *ngIf="displayComparisons"
                                          [scheme]="'picnic'"
                                          [results]="gaGroupedBarChart"
                                          [gradient]="true"
                                          [xAxis]="showXAxis"
                                          [yAxis]="showYAxis"
                                          [legend]="true"
                                          [legendPosition]="LegendPosition.Below"
                                          [showXAxisLabel]="showXAxisLabel"
                                          [showYAxisLabel]="showYAxisLabel"
                                          [roundEdges]="false"
                                          [roundDomains]="true"
                                          [xAxisLabel]="xAxisLabel"
                                          [yAxisLabel]="'Unique Site Visitors'"
              >
              </ngx-charts-bar-vertical-2d>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="report-container">
            <div class="report-title">
              Opportunity-to-Lead
            </div>
            <div class="report-subtitle">
              (Last {{ monthCount }} months)
            </div>
            <div class="report-data" *ngIf="isVisible['analytics']">
              <ngx-charts-line-chart *ngIf="!displayComparisons"
                                     [scheme]="'forest'"
                                     [showXAxisLabel]="showXAxisLabel"
                                     [showYAxisLabel]="showYAxisLabel"
                                     [xAxis]="true"
                                     [yAxis]="true"
                                     [xAxisLabel]="'Month & Year'"
                                     [yAxisLabel]="'Opportunity-to-Lead (%)'"
                                     [roundDomains]="true"
                                     [legendPosition]="LegendPosition.Below"
                                     [legend]="false"
                                     [results]="opportunityLineChart"
                                     [curve]="curve"
                                     [yAxisTickFormatting]="percentageFormatting"
              >
              </ngx-charts-line-chart>
              <ngx-charts-line-chart *ngIf="displayComparisons"
                                     [scheme]="'forest'"
                                     [showXAxisLabel]="showXAxisLabel"
                                     [showYAxisLabel]="showYAxisLabel"
                                     [xAxis]="true"
                                     [yAxis]="true"
                                     [xAxisLabel]="'Month & Year'"
                                     [yAxisLabel]="'Opportunity-to-Lead (%)'"
                                     [roundDomains]="true"
                                     [legendPosition]="LegendPosition.Below"
                                     [legend]="true"
                                     [results]="opportunityGroupedLineChart"
                                     [yAxisTickFormatting]="percentageFormatting"
                                     [curve]="curve"
              >
              </ngx-charts-line-chart>
            </div>
          </div>
        </div>
      </div>
      <div class="row report-row" [class.legend]="displayComparisons" style="min-height: 500px"
           snInViewport
           (inViewportChange)="handleViewportChange($event, 'leads')"
           [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}"
      >
        <div class="col-6 d-flex">
          <div class="report-container flex-grow-1 d-flex flex-column">
            <div class="report-title">
              Captured Leads Count
            </div>
            <div class="report-subtitle">
              (Last {{ monthCount }} months)
            </div>
            <div class="report-data flex-grow-1" *ngIf="isVisible['leads']">
              <ngx-charts-bar-vertical-stacked *ngIf="!displayComparisons"
                                               [customColors]="customColors"
                                               [results]="leadBarChartStacked"
                                               [gradient]="true"
                                               [xAxis]="showXAxis"
                                               [yAxis]="showYAxis"
                                               [showDataLabel]="true"
                                               [showXAxisLabel]="showXAxisLabel"
                                               [showYAxisLabel]="showYAxisLabel"
                                               [xAxisLabel]="xAxisLabel"
                                               [yAxisLabel]="'Captured Leads Count'"
              >
              </ngx-charts-bar-vertical-stacked>
              <ngx-charts-bar-vertical-2d *ngIf="displayComparisons"
                                          [scheme]="'cool'"
                                          [results]="leadGroupedBarChart"
                                          [gradient]="true"
                                          [xAxis]="showXAxis"
                                          [yAxis]="showYAxis"
                                          [legend]="true"
                                          [legendPosition]="LegendPosition.Below"
                                          [showXAxisLabel]="showXAxisLabel"
                                          [showYAxisLabel]="showYAxisLabel"
                                          [roundEdges]="false"
                                          [roundDomains]="true"
                                          [xAxisLabel]="xAxisLabel"
                                          [yAxisLabel]="'Captured Leads Count'"
                                          [rotateXAxisTicks]="true"
              >
              </ngx-charts-bar-vertical-2d>
            </div>
          </div>
        </div>
        <div class="col-6 d-flex">
          <div class="report-container flex-grow-1 d-flex flex-column">
            <div class="report-title">
              Lead Valuation
            </div>
            <div class="report-subtitle">
              (Last {{ monthCount }} months)
            </div>
            <div class="report-data flex-grow-1" *ngIf="isVisible['leads']">
              <ngx-charts-bar-vertical-stacked
                                               [customColors]="customColorsValue"
                                               [results]="leadBarChartStackedValuation"
                                               [gradient]="true"
                                               [xAxis]="showXAxis"
                                               [yAxis]="showYAxis"
                                               [showDataLabel]="true"
                                               [showXAxisLabel]="showXAxisLabel"
                                               [showYAxisLabel]="showYAxisLabel"
                                               [xAxisLabel]="xAxisLabel"
                                               [dataLabelFormatting]="currencyFormatting"
                                               [yAxisTickFormatting]="currencyFormatting"
                                               [yAxisLabel]="'Lead Valuation'"
              >
              </ngx-charts-bar-vertical-stacked>
            </div>
          </div>
        </div>

      </div>

      <div class="row report-row align-items-stretch" [class.legend]="displayComparisons"
           snInViewport
           (inViewportChange)="handleViewportChange($event, 'websiteLeads')"
           [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}"
      >
        <div class="col-12 d-flex">
          <div class="report-container flex-grow-1 d-flex flex-column">
            <div class="report-title">Monthly Leads Captured</div>
            <div class="report-subtitle">{{ reportData.monthAndYear }}</div>
            <div class="report-data flex-grow-1" *ngIf="isVisible['websiteLeads']">
              <p-table [value]="reportData.websiteLead.leadSource" dataKey="source" [tableStyle]="{'font-size': '0.9em'}" [styleClass]="'p-datatable-sm'" @fadeIn>
                <ng-template pTemplate="caption">
                  <div class="flex flex-wrap justify-content-end gap-2">
                  </div>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr class="custom-tr">
                    <th style="width: 5rem"></th>
                    <th pSortableColumn="source">Source <p-sortIcon field="source" /></th>
                    <th pSortableColumn="leadType" class="align-center">Lead Type <p-sortIcon field="leadType" /></th>
                    <th pSortableColumn="totalLeads">Total Leads <p-sortIcon field="totalLeads" /></th>
                    <th pSortableColumn="totalValues" class="align-right">Total Values <p-sortIcon field="totalValues" /></th>
                    <th pSortableColumn="open">Open <p-sortIcon field="open" /></th>
                    <th pSortableColumn="won">Won <p-sortIcon field="won" /></th>
                    <th pSortableColumn="lost">Lost <p-sortIcon field="lost" /></th>
                    <th pSortableColumn="abandoned">Abandoned <p-sortIcon field="abandoned" /></th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-leadSource let-expanded="expanded">
                  <tr>
                    <td>
                      <p-button type="button" pRipple [pRowToggler]="leadSource" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                    </td>
                    <td>{{ leadSource.source }}</td>
                    <td class="align-center">
                      <p-tag class="primary-tag" *ngIf="leadSource.leadType === 'Website Lead'" icon="pi pi-home" severity="secondary" value="{{ leadSource.leadType.toUpperCase() }}" />
                      <p-tag class="secondary-tag" *ngIf="leadSource.leadType === 'Manual User Input'" icon="pi pi-user-edit" value="{{ leadSource.leadType.toUpperCase() }}" />
                    </td>
                    <td [class.zero-value]="leadSource.totalLeads === 0" class="align-right">{{ leadSource.totalLeads }}</td>
                    <td [class.zero-value]="leadSource.totalValues === 0" class="align-right">{{ leadSource.totalValues | currency : 'USD' }}</td>
                    <td [class.zero-value]="leadSource.open === 0" class="align-center">{{ leadSource.open }}</td>
                    <td [class.zero-value]="leadSource.won === 0" class="align-center">{{ leadSource.won }}</td>
                    <td [class.zero-value]="leadSource.lost === 0" class="align-center">{{ leadSource.lost }}</td>
                    <td [class.zero-value]="leadSource.abandoned === 0" class="align-center">{{ leadSource.abandoned }}</td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-leadSource>
                  <tr>
                    <td colspan="9">
                      <div class="p-3">
                        <p-table [value]="leadSource.leadContacts" dataKey="contactName"  [tableStyle]="{'font-size': '0.8em'}" [styleClass]="'p-datatable-sm'">
                          <ng-template pTemplate="header">
                            <tr>
                              <th></th>
                              <th pSortableColumn="contactName">Contact Name <p-sortIcon field="contactName" /></th>
                              <th pSortableColumn="contactSource">Contact Source <p-sortIcon field="contactSource" /></th>
                              <th pSortableColumn="createdBySource">Created By Source <p-sortIcon field="createdBySource" /></th>
                              <th pSortableColumn="dateAdded">Date Added <p-sortIcon field="dateAdded" /></th>
                              <th pSortableColumn="status">Status <p-sortIcon field="status" /></th>
                              <th pSortableColumn="ownerName">Owner <p-sortIcon field="ownerName" /></th>
                            </tr>
                          </ng-template>
                          <ng-template pTemplate="body" let-contact>
                            <tr>
                              <td class="align-center">
                                <div [ngStyle]="{'background-color': getRandomColor(contact.contactName)}"
                                     class="avatar-icon">
                                  {{ getInitials(contact.contactName) }}
                                </div>
                              </td>
                              <td class="align-left">{{ contact.contactName }}</td>
                              <td>{{ contact.contactSource }}</td>
                              <td>{{ contact.createdBySource }}</td>
                              <td>{{ contact.dateAdded }}</td>
                              <td>
                                <p-tag [value]="contact.status" [severity]="getStatusSeverity(contact.status)" />
                              </td>
                              <td>
                                <span *ngIf="contact.ownerName" class="d-flex align-items-center"><p-avatar
                                  image="{{ contact.ownerPhotoUrl }}"
                                  [style]="{ 'margin-right': '12px'}"
                                  shape="circle"/> {{ contact.ownerName }}</span>
                                <span *ngIf="!contact.ownerName" class="d-flex align-items-center"><p-avatar
                                  label="U" [style]="{ 'margin-right': '12px', 'background-color': '#ece9fc', color: '#2a1261' }"
                                  shape="circle"/> Unassigned</span>
                              </td>
                            </tr>
                          </ng-template>
                          <ng-template pTemplate="emptymessage">
                            <tr>
                              <td colspan="7">No contacts available for this lead source.</td>
                            </tr>
                          </ng-template>
                        </p-table>
                      </div>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="footer">
                  <tr class="custom-tr">
                    <td></td>
                    <td></td>
                    <td class="align-center font-bold">TOTAL</td>
                    <td class="align-right font-bold">{{ reportData.websiteLead.totalLeads }}</td>
                    <td class="align-right font-bold">{{ reportData.websiteLead.totalValues | currency }}</td>
                    <td class="align-center font-bold">{{ reportData.websiteLead.totalOpen }}</td>
                    <td class="align-center font-bold">{{ reportData.websiteLead.totalWon }}</td>
                    <td class="align-center font-bold">{{ reportData.websiteLead.totalLost }}</td>
                    <td class="align-center font-bold">{{ reportData.websiteLead.totalAbandoned }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>
      </div>
      <div class="row report-row align-items-stretch"
           snInViewport
           (inViewportChange)="handleViewportChange($event, 'appointments')"
           [inViewportOptions]="{rootMargin: '0px', threshold: 0.5}"
      >
        <div class="col-7 d-flex">
          <div class="report-container custom-dropdown-container">
            <div class="report-title">
              Appointments
            </div>
            <div class="report-subtitle">
              {{ reportData.monthAndYear }}
            </div>
            <div class="row" *ngIf="isVisible['appointments']">
              <div class="col-12 report-data">
                <div class="custom-dropdown corner-right">
                  <p-floatLabel>
                    <p-dropdown
                      [options]="filteredCalendars"
                      [(ngModel)]="selectedCalendar"
                      optionLabel="calendarName"
                      placeholder="Select a Calendar"
                      [filter]="true"
                      filterBy="calendarName"
                      (onChange)="onCalendarChange($event)"
                      id="float-labeld"
                    />
                    <label for="float-labeld">Select Calendar</label>
                  </p-floatLabel>
                </div>
                <ngx-charts-advanced-pie-chart
                  [view]="[700, 250]"
                  [scheme]="'forest'"
                  [results]="appointmentsPieChart"
                  [gradient]="gradient"
                >
                </ngx-charts-advanced-pie-chart>
              </div>
            </div>
          </div>
        </div>
        <div class="col-5 d-flex">
          <div class="report-container">
            <div class="report-title">
              Contacts Won
            </div>
            <div class="report-subtitle">
              {{ reportData.monthAndYear }}
            </div>
            <div class="report-data" *ngIf="isVisible['appointments']">
              <ng-container *ngIf="reportData.contactsWon.length > 0; else noContactsTemplate">
                <p-table [value]="reportData.contactsWon" [tableStyle]="{'font-size': '0.8em'}"
                         [responsiveLayout]="'scroll'" [styleClass]="'p-datatable-sm'"
                         [scrollable]="true"
                         scrollHeight="275px"
                         @fadeIn>
                  <ng-template pTemplate="header">
                    <tr>
                      <th></th>
                      <th>Name</th>
                      <th>Source</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-contactWon>
                    <tr>
                      <td class="align-center">
                        <div [ngStyle]="{'background-color': getRandomColor(contactWon.contactName)}"
                             class="avatar-icon">
                          {{ getInitials(contactWon.contactName) }}
                        </div>
                      </td>
                      <td class="align-left">{{ contactWon.contactName }}</td>
                      <td class="align-left">{{ contactWon.contactSource ? contactWon.contactSource : 'N/A' }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </ng-container>
              <ng-template #noContactsTemplate>
                <div class="no-data-placeholder" @fadeIn>
                  <div>
                    <i class="pi pi-address-book"></i> No contacts won.
                  </div>
                </div>
              </ng-template>
            </div>
          </div>
        </div>

      </div>
      <div class="row report-row"
           snInViewport
           (inViewportChange)="handleViewportChange($event, 'pipelines')"
           [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}"
      >
        <div class="col-12">
          <div class="report-container">
            <div class="report-title">
              Pipeline Stages
            </div>
            <div class="report-subtitle">
              {{ reportData.monthAndYear }}
            </div>
            <div class="row" *ngIf="isVisible['pipelines']">
              <div class="col-6 report-data">
                <div class="custom-dropdown">
                  <p-floatLabel>
                    <p-dropdown
                      [options]="reportData.pipelines"
                      [(ngModel)]="selectedPipeline"
                      optionLabel="pipelineName"
                      placeholder="Select a Pipeline"
                      (onChange)="onPipelineChange($event)"
                      id="float-label"
                    />
                    <label for="float-label">Select Pipeline</label>
                  </p-floatLabel>
                </div>
                <p-table [value]="selectedPipeline!.pipelineStages" [tableStyle]="{'font-size': '0.8em'}"
                         [responsiveLayout]="'scroll'" [styleClass]="'p-datatable-sm'" @fadeIn>
                  <ng-template pTemplate="header">
                    <tr class="custom-tr">
                      <th>Pipeline Stage</th>
                      <th class="align-center">#</th>
                      <th class="align-center">%</th>
                      <th class="align-right">$</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-pipelineStage>
                    <tr>
                      <td class="align-left">{{ pipelineStage.stageName }}</td>
                      <td [class.zero-value]="pipelineStage.count === 0"
                          class="align-center">{{ pipelineStage.count }}
                      </td>
                      <td [class.zero-value]="pipelineStage.percentage === 0"
                          class="align-center">{{ pipelineStage.percentage }}%
                      </td>
                      <td [class.zero-value]="pipelineStage.monetaryValue === 0"
                          class="align-right">{{ pipelineStage.monetaryValue | currency }}
                      </td>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="footer">
                    <tr class="custom-tr">
                      <td class="align-center font-bold">TOTAL</td>
                      <td class="align-center font-bold">{{ getTotalCounts(selectedPipeline!.pipelineStages) }}</td>
                      <td
                        class="align-center font-bold">{{ getTotalPercentage(selectedPipeline!.pipelineStages) | number:'1.0-2' }}
                        %
                      </td>
                      <td
                        class="align-right font-bold">{{ getTotalMonetaryValue(selectedPipeline!.pipelineStages) | currency }}
                      </td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
              <div class="col-6 report-data">
                <ngx-charts-pie-chart *ngIf="!selectedPipelineNoData"
                                      [view]="[400, 425]"
                                      [scheme]="'picnic'"
                                      [results]="pipelinesPieChart"
                                      [gradient]="true"
                                      [maxLabelLength]="15"
                                      [trimLabels]="true"
                                      [legendTitle]="'Legend'"
                                      [legendPosition]="LegendPosition.Right"
                                      [legend]="true"
                                      [doughnut]="true"
                                      [arcWidth]=".25"
                >
                </ngx-charts-pie-chart>
                <div class="no-data-placeholder" @fadeIn *ngIf="selectedPipelineNoData">
                  <div>
                    <i class="pi pi-info-circle"></i> No data for this pipeline.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <ng-container *ngIf="reportData.monthlyClarityReport && reportData.monthlyClarityReport.deviceClarityAggregate.length > 0">
        <h2>Website Analytics</h2>
        <div class="row report-row align-items-stretch"
             snInViewport
             (inViewportChange)="handleViewportChange($event, 'averageScrollDepth')"
             [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}"
        >
          <div class="col-4 d-flex">
            <div class="report-container report-container-sm">
              <div class="report-title">Average Scroll Depth</div>
              <div class="report-subtitle">{{ reportData.monthAndYear }}</div>
              <div class="report-data top-deficit" *ngIf="isVisible['averageScrollDepth']">
                <ngx-charts-gauge
                  [scheme]="'nightLights'"
                  [results]="clarityAverageScrollGaugeChart"
                  [angleSpan]="240"
                  [legend]="true"
                  [legendPosition]="LegendPosition.Below"
                  [bigSegments]="4"
                  [startAngle]="-120"
                  [max]="100"
                  [showText]="false"
                  [legendTitle]="'Device Type'"
                  [valueFormatting]="valueFormatting"
                >
                </ngx-charts-gauge>
              </div>
            </div>
          </div>
          <div class="col-4 d-flex">
            <div class="report-container report-container-sm">
              <div class="report-title">Total Session Count</div>
              <div class="report-subtitle">{{ reportData.monthAndYear }}</div>
              <div class="report-data" *ngIf="isVisible['averageScrollDepth']">
                <ngx-charts-pie-grid
                  [scheme]="'nightLights'"
                  [results]="clarityTotalSessionsPieChart"
                >
                </ngx-charts-pie-grid>
              </div>
            </div>
          </div>
          <div class="col-4 d-flex">
            <div class="report-container report-container-sm">
              <div class="report-title">Total Active Time</div>
              <div class="report-subtitle">{{ reportData.monthAndYear }}</div>
              <div class="report-data" *ngIf="isVisible['averageScrollDepth']">
                <ngx-charts-bar-vertical
                  [results]="clarityTotalActiveTimeTreeMap"
                  [scheme]="'nightLights'"
                  [roundEdges]="false"
                  [gradient]="gradient"
                  [xAxis]="true"
                  [yAxis]="false"
                  [showDataLabel]="true"
                  [showXAxisLabel]="true"
                  [showYAxisLabel]="false"
                  [xAxisLabel]="'Device Types'"
                  [roundDomains]="true"
                  [dataLabelFormatting]="timeFormatting"
                >
                </ngx-charts-bar-vertical>
              </div>
            </div>
          </div>
        </div>
        <div class="row report-row align-items-stretch"
             snInViewport
             (inViewportChange)="handleViewportChange($event, 'urlMetrics')"
             [inViewportOptions]="{rootMargin: '0px', threshold: 0.65}"
        >
          <div class="col-12">
            <div class="report-container report-container-sm clarity-container">
              <div class="report-title">URL Metrics</div>
              <div class="report-subtitle">{{ reportData.monthAndYear }}</div>
              <div class="report-data" *ngIf="isVisible['urlMetrics']">
                <div class="custom-dropdown corner-right">
                  <p-floatLabel>
                    <p-dropdown
                      [options]="deviceTypes"
                      [(ngModel)]="selectedDevice"
                      (onChange)="onDeviceChange($event)"
                      id="float-label-device"
                    />
                    <label for="float-label-device">Select Device</label>
                  </p-floatLabel>
                </div>
                <div class="row">
                  <p-table
                    #dt1
                    [value]="reportData.monthlyClarityReport.urls"
                    dataKey="id"
                    [rows]="10"
                    [rowsPerPageOptions]="[10, 25, 50]"
                    [breakpoint]="'960px'"
                    [loading]="false"
                    [paginator]="true"
                    [globalFilterFields]="['url']"
                    [tableStyle]="{'font-size': '0.8em'}"
                    [responsiveLayout]="'scroll'"
                    [styleClass]="'p-datatable-sm'"
                    @fadeIn
                  >
                    <ng-template pTemplate="header">
                      <tr class="custom-tr">
                        <th style="min-width:20rem">
                          <div class="flex align-items-center">
                            URL
                            <p-columnFilter type="text" field="url" display="menu"></p-columnFilter>
                          </div>
                        </th>
                        <th style="min-width:12.5rem" pSortableColumn="averageScrollDepth">
                          <div class="flex align-items-center">
                            Average Scroll Depth
                            <p-sortIcon field="averageScrollDepth"></p-sortIcon>
                          </div>
                        </th>
                        <th style="min-width:12.5rem" pSortableColumn="activeTime">
                          <div class="flex align-items-center">
                            Active Time
                            <p-sortIcon field="activeTime"></p-sortIcon>
                          </div>
                        </th>
                        <th style="min-width:12.5rem" pSortableColumn="totalSessionCount">
                          <div class="flex align-items-center">
                            Session Count
                            <p-sortIcon field="totalSessionCount"></p-sortIcon>
                          </div>
                        </th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-urlMetric>
                      <tr>
                        <td>
                          <a [href]="urlMetric.url" target="_blank" style="color: #17a2b8; text-decoration: none;">
                            {{ urlMetric.url }}
                          </a>
                        </td>
                        <td>{{ percentageFormatting(urlMetric.averageScrollDepth) }}</td>
                        <td>{{ timeFormatting(urlMetric.activeTime) }}</td>
                        <td>{{ urlMetric.totalSessionCount }}</td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td colspan="4">No data available.</td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</ng-container>
</ng-container>
<ng-template #loadingOrError>
  <div class="container">
    <div class="report-loading">
      <img
        src="https://firebasestorage.googleapis.com/v0/b/highlevel-backend.appspot.com/o/companyPhotos%2FqifAU6T7cfOK6S72c8e2.png?alt=media&token=be357fe1-bceb-4b8e-9e09-77c0c2217359"
        alt="Loading Image" class="loading-image"/>
      <p class="loading-message">Loading your report data...</p>
      <p-progressSpinner
        strokeWidth="4"
        fill="var(--surface-ground)"
        animationDuration=".5s"/>
    </div>
  </div>
</ng-template>
<ng-template #noDataTemplate>
  <div class="header-container sticky">
    <div class="container header-sub-container">
      <div class="dropdown-container">
        <p-dropdown
          [options]="months"
          [(ngModel)]="selectedMonth"
          (onChange)="onMonthChange()"
        />
        <p-dropdown
          [options]="years"
          [(ngModel)]="selectedYear"
          (onChange)="onYearChange()"
        />
      </div>
    </div>
  </div>
  <div class="no-data-placeholder" @fadeIn>
    <div>
      <i class="pi pi-info-circle"></i> Report data is unavailable for the month of {{ selectedMonth }}, {{ selectedYear }}.
    </div>
  </div>
</ng-template>
